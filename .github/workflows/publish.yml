name: Publish (GitHub Release)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    environment: "build and publish"
    env:
      MOD_VERSION: ""
      RELEASE_TAG: ""
      RELEASE_TAG_INPUT: ""
      ARCHIVES_BASE_NAME: ""
      MINECRAFT_VERSION: ""
      ARTIFACT_VERSION: ""
      MODRINTH_PROJECT_ID: ""
      CURSEFORGE_PROJECT_ID: ""
      MODRINTH_VERSION_TYPE: ""
      CURSEFORGE_RELEASE_TYPE: ""
      CURSEFORGE_GAME_VERSIONS: ""
      IS_GH_PRERELEASE: ""
      RELEASE_BODY: ""

    steps:
      - name: Resolve latest stable release tag (manual)
        id: latest_stable
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Latest stable (non-prerelease, non-draft) release.
          tag="$(gh api "repos/${GH_REPO}/releases/latest" --jq '.tag_name')"

          if [[ -z "${tag}" ]]; then
            echo "Unable to determine latest stable release tag via GitHub API."
            exit 1
          fi

          # Accept SemVer tags like:
          # - v1.2.3 (stable)
          # - v1.2.3-rc.1 (prerelease)
          # (Build metadata is intentionally disallowed for tags.)
          if ! [[ "${tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Latest stable release tag (${tag}) must be semver in the form vX.Y.Z or vX.Y.Z-PRERELEASE."
            exit 1
          fi

          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Checkout (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ steps.latest_stable.outputs.tag }}
          fetch-depth: 0
          fetch-tags: true

      - name: Checkout (from Release workflow)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve GitHub Release metadata
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          EVENT_NAME: ${{ github.event_name }}
          LATEST_STABLE_TAG: ${{ steps.latest_stable.outputs.tag }}
        run: |
          set -euo pipefail

          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            tag="${LATEST_STABLE_TAG}"
            if [[ -z "${tag}" ]]; then
              echo "Latest stable tag is empty; cannot proceed."
              exit 1
            fi
          elif [[ "${EVENT_NAME}" == "workflow_run" ]]; then
            mapfile -t tags < <(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$' || true)
            if (( ${#tags[@]} == 0 )); then
              echo "No SemVer tag found pointing at HEAD ($(git rev-parse --short=12 HEAD))."
              echo "Tags pointing at HEAD:"
              git tag --points-at HEAD || true
              exit 1
            fi
            if (( ${#tags[@]} > 1 )); then
              echo "Multiple SemVer tags point at HEAD ($(git rev-parse --short=12 HEAD)); unable to pick one:"
              printf '%s\n' "${tags[@]}"
              exit 1
            fi
            tag="${tags[0]}"
          else
            echo "Unsupported event: ${EVENT_NAME}"
            exit 1
          fi

          echo "RELEASE_TAG_INPUT=${tag}" >> "${GITHUB_ENV}"

          release_json="$(gh release view "${tag}" --repo "${GH_REPO}" --json body,isPrerelease,isDraft,isImmutable)"

          is_draft="$(echo "${release_json}" | jq -r '.isDraft')"
          if [[ "${is_draft}" == "true" ]]; then
            echo "GitHub release (${tag}) is a draft; refusing to publish."
            exit 1
          fi

          is_immutable="$(echo "${release_json}" | jq -r '.isImmutable')"
          if [[ "${is_immutable}" != "true" ]]; then
            echo "GitHub release (${tag}) is not immutable; refusing to publish."
            exit 1
          fi

          prerelease="$(echo "${release_json}" | jq -r '.isPrerelease')"
          echo "IS_GH_PRERELEASE=${prerelease}" >> "${GITHUB_ENV}"

          delimiter="CBBG_RELEASE_BODY_$(date +%s%N)"
          {
            echo "RELEASE_BODY<<${delimiter}"
            echo "${release_json}" | jq -r '.body'
            echo "${delimiter}"
          } >> "${GITHUB_ENV}"

      - name: Set up JDK 21
        uses: actions/setup-java@v5.1.0
        with:
          java-version: "21"
          distribution: "temurin"

      # Cache Fabric Loom's project-local cache (Minecraft jars, mappings, remapped artifacts, etc).
      # This is separate from Gradle User Home (~/.gradle) caching handled by setup-gradle.
      - name: Cache Loom artifacts
        uses: actions/cache@v5.0.1
        with:
          path: |
            .gradle/loom-cache
          key: ${{ runner.os }}-loom-${{ hashFiles('gradle.properties', 'settings.gradle', 'build.gradle', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-loom-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5.0.0
        with:
          # Publishing is trusted, so allow cache writes.
          cache-read-only: false
          cache-cleanup: on-success

      - name: Read metadata + validate tag
        shell: bash
        run: |
          set -euo pipefail

          tag="${RELEASE_TAG_INPUT}"

          # Accept SemVer tags like:
          # - v1.2.3 (stable)
          # - v1.2.3-rc.1 (prerelease)
          # (Build metadata is intentionally disallowed for tags.)
          if ! [[ "${tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Tag (${tag}) must be semver in the form vX.Y.Z or vX.Y.Z-PRERELEASE."
            exit 1
          fi
          version="${tag#v}"

          mod_version="$(grep -E '^mod_version=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${mod_version}" ]]; then
            echo "mod_version is empty in gradle.properties."
            exit 1
          fi
          if [[ "${version}" != "${mod_version}" ]]; then
            echo "Release tag (${tag}) does not match gradle.properties mod_version (${mod_version}). Expected tag v${mod_version}."
            exit 1
          fi

          archives_base_name="$(grep -E '^archives_base_name=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${archives_base_name}" ]]; then
            echo "archives_base_name is empty in gradle.properties."
            exit 1
          fi

          minecraft_version="$(grep -E '^minecraft_version=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${minecraft_version}" ]]; then
            echo "minecraft_version is empty in gradle.properties."
            exit 1
          fi

          modrinth_project_id="$(grep -E '^modrinth_project_id=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${modrinth_project_id}" ]]; then
            echo "modrinth_project_id is empty in gradle.properties."
            exit 1
          fi

          curseforge_project_id="$(grep -E '^curseforge_project_id=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${curseforge_project_id}" ]]; then
            echo "curseforge_project_id is empty in gradle.properties."
            exit 1
          fi

          artifact_version="${mod_version}+mc${minecraft_version}"

          minecraft_series="$(echo "${minecraft_version}" | awk -F. '{print $1 "." $2}')"
          curseforge_game_versions="Minecraft ${minecraft_series}:${minecraft_version},Java 21,Fabric,Environment:Client"

          if [[ "${IS_GH_PRERELEASE}" == "true" ]]; then
            modrinth_version_type="beta"
            curseforge_release_type="beta"
          else
            modrinth_version_type="release"
            curseforge_release_type="release"
          fi

          echo "MOD_VERSION=${mod_version}" >> "${GITHUB_ENV}"
          echo "RELEASE_TAG=${tag}" >> "${GITHUB_ENV}"
          echo "ARCHIVES_BASE_NAME=${archives_base_name}" >> "${GITHUB_ENV}"
          echo "MINECRAFT_VERSION=${minecraft_version}" >> "${GITHUB_ENV}"
          echo "ARTIFACT_VERSION=${artifact_version}" >> "${GITHUB_ENV}"
          echo "MODRINTH_PROJECT_ID=${modrinth_project_id}" >> "${GITHUB_ENV}"
          echo "CURSEFORGE_PROJECT_ID=${curseforge_project_id}" >> "${GITHUB_ENV}"
          echo "MODRINTH_VERSION_TYPE=${modrinth_version_type}" >> "${GITHUB_ENV}"
          echo "CURSEFORGE_RELEASE_TYPE=${curseforge_release_type}" >> "${GITHUB_ENV}"
          echo "CURSEFORGE_GAME_VERSIONS=${curseforge_game_versions}" >> "${GITHUB_ENV}"

      - name: Validate publishing secrets are available
        shell: bash
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${MODRINTH_TOKEN}" ]]; then
            echo "Missing secret: MODRINTH_TOKEN (configured as an Environment secret; make sure the environment name matches: 'build and publish')."
            exit 1
          fi
          if [[ -z "${CF_API_TOKEN}" ]]; then
            echo "Missing secret: CF_API_TOKEN (configured as an Environment secret; make sure the environment name matches: 'build and publish')."
            exit 1
          fi

      - name: Build with Gradle Wrapper
        run: ./gradlew build

      - name: Validate artifact exists
        shell: bash
        run: |
          set -euo pipefail

          jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}.jar"
          if [[ ! -f "${jar}" ]]; then
            echo "Missing artifact: ${jar}"
            ls -la build/libs || true
            exit 1
          fi

      - name: Publish to Modrinth
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          MODRINTH_PROJECT_ID: ${{ env.MODRINTH_PROJECT_ID }}
          MODRINTH_VERSION_NUMBER: ${{ env.ARTIFACT_VERSION }}
          MODRINTH_VERSION_TYPE: ${{ env.MODRINTH_VERSION_TYPE }}
          MODRINTH_CHANGELOG: ${{ env.RELEASE_BODY }}
        run: ./gradlew modrinth

      - name: Upload to CurseForge
        id: curseforge_upload
        uses: itsmeow/curseforge-upload@v3.1.2
        with:
          token: ${{ secrets.CF_API_TOKEN }}
          project_id: ${{ env.CURSEFORGE_PROJECT_ID }}
          game_endpoint: minecraft
          relations: "fabric-api:requiredDependency"
          file_path: build/libs/${{ env.ARCHIVES_BASE_NAME }}-${{ env.ARTIFACT_VERSION }}.jar
          game_versions: ${{ env.CURSEFORGE_GAME_VERSIONS }}
          release_type: ${{ env.CURSEFORGE_RELEASE_TYPE }}
          display_name: cbbg ${{ env.ARTIFACT_VERSION }}
          changelog: ${{ env.RELEASE_BODY }}
          changelog_type: markdown

      - name: Print CurseForge upload result
        shell: bash
        run: |
          set -euo pipefail

          cf_file_id="${{ steps.curseforge_upload.outputs.id }}"
          if [[ -z "${cf_file_id}" ]]; then
            echo "CurseForge uploader did not return an output file id."
            exit 1
          fi

          echo "CurseForge file id: ${cf_file_id}"
          echo "CurseForge file URL: https://www.curseforge.com/minecraft/mc-mods/cbbg/files/${cf_file_id}"
