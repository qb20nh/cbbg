name: Release

on:
  push:
    tags:
      # This is a glob (not a regex). Exact SemVer validation is enforced in the "Validate tag" step below.
      - "v*.*.*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.1
        with:
          # Branch gating needs ancestry checks against remote branches.
          # Full history keeps the checks reliable.
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 21
        uses: actions/setup-java@v5.1.0
        with:
          java-version: "21"
          distribution: "temurin"

      # Cache Fabric Loom's project-local cache (Minecraft jars, mappings, remapped artifacts, etc).
      # This is separate from Gradle User Home (~/.gradle) caching handled by setup-gradle.
      - name: Cache Loom artifacts
        uses: actions/cache@v5.0.1
        with:
          path: |
            .gradle/loom-cache
          key: ${{ runner.os }}-loom-${{ hashFiles('gradle.properties', 'settings.gradle', 'build.gradle', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-loom-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5.0.0
        with:
          # Use GitHub Actions cache for Gradle User Home (~/.gradle), including dependency cache
          # and the local Gradle build cache.
          #
          # Release builds are trusted, so allow cache writes.
          cache-read-only: false
          # Keep cache size under control.
          cache-cleanup: on-success

      - name: Validate tag matches gradle.properties
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"

          # Tag format (all branches):
          # - Stable:     vX.Y.Z+mc<MINECRAFT_VERSION>
          # - Prerelease: vX.Y.Z-rc.1+mc<MINECRAFT_VERSION>
          #
          # The mc suffix prevents collisions across maintenance lines.
          #
          # Note: The workflow trigger above is only a glob; the regex here is the real gate.
          #
          # minecraft_version is validated as SemVer build-metadata identifiers:
          #   [0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*
          if ! [[ "${tag}" =~ ^v([0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?)\\+mc([0-9A-Za-z-]+(\\.[0-9A-Za-z-]+)*)$ ]]; then
            echo "Tag (${tag}) must be in the form vX.Y.Z(-PRERELEASE)?+mc<MINECRAFT_VERSION>."
            exit 1
          fi
          version="${BASH_REMATCH[1]}"
          tag_minecraft_version="${BASH_REMATCH[3]}"

          is_prerelease=0
          if [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            is_prerelease=1
          fi

          mod_version="$(grep -E '^mod_version=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ "${version}" != "${mod_version}" ]]; then
            echo "Tag (${tag}) does not match gradle.properties mod_version (${mod_version}). Expected tag v${mod_version}+mc${tag_minecraft_version}."
            exit 1
          fi

          archives_base_name="$(grep -E '^archives_base_name=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${archives_base_name}" ]]; then
            echo "archives_base_name is empty in gradle.properties."
            exit 1
          fi

          minecraft_version="$(grep -E '^minecraft_version=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${minecraft_version}" ]]; then
            echo "minecraft_version is empty in gradle.properties."
            exit 1
          fi
          if [[ "${tag_minecraft_version}" != "${minecraft_version}" ]]; then
            echo "Tag (${tag}) minecraft version (${tag_minecraft_version}) does not match gradle.properties minecraft_version (${minecraft_version})."
            exit 1
          fi

          # Branch gating
          # Prevent accidental releases from random branches by requiring the tagged commit to be
          # contained in either:
          # - origin/main (canonical line), or
          # - origin/mc<minecraft_version> (maintenance line for this Minecraft version)
          expected_branch="mc${minecraft_version}"

          git fetch --prune --tags origin "+refs/heads/*:refs/remotes/origin/*"

          sha="$(git rev-parse HEAD)"
          allowed=0

          if git show-ref --verify --quiet "refs/remotes/origin/main" \
            && git merge-base --is-ancestor "${sha}" "refs/remotes/origin/main"; then
            allowed=1
          fi

          if git show-ref --verify --quiet "refs/remotes/origin/${expected_branch}" \
            && git merge-base --is-ancestor "${sha}" "refs/remotes/origin/${expected_branch}"; then
            allowed=1
          fi

          if [[ "${allowed}" -ne 1 ]]; then
            echo "Tag (${tag}) points to commit ${sha}, which is not contained in origin/main or origin/${expected_branch}."
            echo "Remote branches containing this commit:"
            git branch -r --contains "${sha}" || true
            exit 1
          fi

          # Release artifacts include Minecraft version as SemVer build metadata:
          # <mod_version>+mc<minecraft_version>
          artifact_version="${mod_version}+mc${minecraft_version}"

          echo "MOD_VERSION=${mod_version}" >> "${GITHUB_ENV}"
          echo "RELEASE_TAG=${tag}" >> "${GITHUB_ENV}"
          echo "ARCHIVES_BASE_NAME=${archives_base_name}" >> "${GITHUB_ENV}"
          echo "MINECRAFT_VERSION=${minecraft_version}" >> "${GITHUB_ENV}"
          echo "ARTIFACT_VERSION=${artifact_version}" >> "${GITHUB_ENV}"
          echo "IS_PRERELEASE=${is_prerelease}" >> "${GITHUB_ENV}"

      - name: Build with Gradle Wrapper
        run: ./gradlew build

      - name: Validate artifacts exist
        shell: bash
        run: |
          set -euo pipefail

          jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}.jar"
          sources_jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}-sources.jar"

          if [[ ! -f "${jar}" ]]; then
            echo "Missing artifact: ${jar}"
            ls -la build/libs || true
            exit 1
          fi

          if [[ ! -f "${sources_jar}" ]]; then
            echo "Missing artifact: ${sources_jar}"
            ls -la build/libs || true
            exit 1
          fi

      - name: Generate artifact checksums (for provenance)
        shell: bash
        run: |
          set -euo pipefail

          jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}.jar"
          sources_jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}-sources.jar"

          sha256sum "${jar}" "${sources_jar}" > subject.checksums.txt

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-checksums: subject.checksums.txt

      - name: Extract release notes from CHANGELOG.md
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import os
          import re
          from pathlib import Path

          tag = os.environ["MOD_VERSION"]
          changelog_path = Path("CHANGELOG.md")
          if not changelog_path.exists():
            raise SystemExit("CHANGELOG.md not found")

          text = changelog_path.read_text(encoding="utf-8")
          lines = text.splitlines()

          header_re = re.compile(rf"^## \[{re.escape(tag)}\]\s+-\s+\d{{4}}-\d{{2}}-\d{{2}}\s*$")
          start = None
          for i, line in enumerate(lines):
            if header_re.match(line):
              start = i
              break

          if start is None:
            raise SystemExit(f"CHANGELOG.md is missing a section header for version {tag}: '## [{tag}] - YYYY-MM-DD'")

          end = len(lines)
          for j in range(start + 1, len(lines)):
            if lines[j].startswith("## ["):
              end = j
              break

          # Exclude the header line itself; keep the content under it.
          body_lines = lines[start + 1 : end]
          body = "\n".join(body_lines).strip()
          if not body:
            raise SystemExit(f"CHANGELOG.md section for {tag} is empty (no content under the version header).")

          Path("release_notes.md").write_text(body + "\n", encoding="utf-8")
          PY

      - name: Create/Update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          release_tag="${RELEASE_TAG}"
          mod_version="${MOD_VERSION}"
          minecraft_version="${MINECRAFT_VERSION}"
          jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}.jar"
          sources_jar="build/libs/${ARCHIVES_BASE_NAME}-${ARTIFACT_VERSION}-sources.jar"

          if [[ "${IS_PRERELEASE}" == "1" ]]; then
            if gh release view "${release_tag}" >/dev/null 2>&1; then
              echo "Prerelease ${release_tag} already exists; updating notes/assets (prereleases are mutable)."
              gh release edit "${release_tag}" \
                --title "cbbg ${mod_version} for Minecraft ${minecraft_version}" \
                --notes-file release_notes.md \
                --prerelease
              gh release upload "${release_tag}" \
                "${jar}" \
                "${sources_jar}" \
                --clobber
            else
              gh release create "${release_tag}" \
                "${jar}" \
                "${sources_jar}" \
                --title "cbbg ${mod_version} for Minecraft ${minecraft_version}" \
                --notes-file release_notes.md \
                --prerelease
            fi
          else
            # Stable releases are immutable: fail if the release already exists.
            if gh release view "${release_tag}" >/dev/null 2>&1; then
              echo "Release ${release_tag} already exists. Stable releases are immutable; refusing to modify it."
              exit 1
            fi
            gh release create "${release_tag}" \
              "${jar}" \
              "${sources_jar}" \
              --title "cbbg ${mod_version} for Minecraft ${minecraft_version}" \
              --notes-file release_notes.md
          fi
