name: Release

on:
  push:
    tags:
      - "*.*.*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@v5.1.0
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5.0.0
        with:
          # Use GitHub Actions cache for Gradle User Home (~/.gradle), including dependency cache
          # and the local Gradle build cache.
          #
          # Release builds are trusted, so allow cache writes.
          cache-read-only: false
          # Keep cache size under control.
          cache-cleanup: on-success

      - name: Validate tag matches gradle.properties
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"

          # Accept SemVer tags like:
          # - 1.2.3 (stable)
          # - 1.2.3-rc.1 (prerelease)
          # (Build metadata is intentionally disallowed for tags.)
          if ! [[ "${tag}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Tag (${tag}) must be semver in the form X.Y.Z or X.Y.Z-PRERELEASE."
            exit 1
          fi
          is_prerelease=0
          if [[ "${tag}" =~ ^[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            is_prerelease=1
          fi

          mod_version="$(grep -E '^mod_version=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ "${tag}" != "${mod_version}" ]]; then
            echo "Tag (${tag}) does not match gradle.properties mod_version (${mod_version})."
            exit 1
          fi

          archives_base_name="$(grep -E '^archives_base_name=' gradle.properties | cut -d= -f2 | tr -d '\r')"
          if [[ -z "${archives_base_name}" ]]; then
            echo "archives_base_name is empty in gradle.properties."
            exit 1
          fi

          echo "MOD_VERSION=${mod_version}" >> "${GITHUB_ENV}"
          echo "ARCHIVES_BASE_NAME=${archives_base_name}" >> "${GITHUB_ENV}"
          echo "IS_PRERELEASE=${is_prerelease}" >> "${GITHUB_ENV}"

      - name: Build with Gradle Wrapper
        run: ./gradlew build

      - name: Validate artifacts exist
        shell: bash
        run: |
          set -euo pipefail

          jar="build/libs/${ARCHIVES_BASE_NAME}-${MOD_VERSION}.jar"
          sources_jar="build/libs/${ARCHIVES_BASE_NAME}-${MOD_VERSION}-sources.jar"

          if [[ ! -f "${jar}" ]]; then
            echo "Missing artifact: ${jar}"
            ls -la build/libs || true
            exit 1
          fi

          if [[ ! -f "${sources_jar}" ]]; then
            echo "Missing artifact: ${sources_jar}"
            ls -la build/libs || true
            exit 1
          fi

      - name: Generate artifact checksums (for provenance)
        shell: bash
        run: |
          set -euo pipefail

          jar="build/libs/${ARCHIVES_BASE_NAME}-${MOD_VERSION}.jar"
          sources_jar="build/libs/${ARCHIVES_BASE_NAME}-${MOD_VERSION}-sources.jar"

          sha256sum "${jar}" "${sources_jar}" > subject.checksums.txt

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-checksums: subject.checksums.txt

      - name: Extract release notes from CHANGELOG.md
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import os
          import re
          from pathlib import Path

          tag = os.environ["MOD_VERSION"]
          changelog_path = Path("CHANGELOG.md")
          if not changelog_path.exists():
            raise SystemExit("CHANGELOG.md not found")

          text = changelog_path.read_text(encoding="utf-8")
          lines = text.splitlines()

          header_re = re.compile(rf"^## \\[{re.escape(tag)}\\]\\s+-\\s+\\d{{4}}-\\d{{2}}-\\d{{2}}\\s*$")
          start = None
          for i, line in enumerate(lines):
            if header_re.match(line):
              start = i
              break

          if start is None:
            raise SystemExit(f"CHANGELOG.md is missing a section header for version {tag}: '## [{tag}] - YYYY-MM-DD'")

          end = len(lines)
          for j in range(start + 1, len(lines)):
            if lines[j].startswith("## ["):
              end = j
              break

          # Exclude the header line itself; keep the content under it.
          body_lines = lines[start + 1 : end]
          body = "\n".join(body_lines).strip()
          if not body:
            raise SystemExit(f"CHANGELOG.md section for {tag} is empty (no content under the version header).")

          Path("release_notes.md").write_text(body + "\n", encoding="utf-8")
          PY

      - name: Create/Update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          tag="${MOD_VERSION}"
          jar="build/libs/${ARCHIVES_BASE_NAME}-${tag}.jar"
          sources_jar="build/libs/${ARCHIVES_BASE_NAME}-${tag}-sources.jar"

          if [[ "${IS_PRERELEASE}" == "1" ]]; then
            if gh release view "${tag}" >/dev/null 2>&1; then
              echo "Prerelease ${tag} already exists; updating notes/assets (prereleases are mutable)."
              gh release edit "${tag}" \
                --title "cbbg ${tag}" \
                --notes-file release_notes.md \
                --prerelease
              gh release upload "${tag}" \
                "${jar}" \
                "${sources_jar}" \
                --clobber
            else
              gh release create "${tag}" \
                "${jar}" \
                "${sources_jar}" \
                --title "cbbg ${tag}" \
                --notes-file release_notes.md \
                --prerelease
            fi
          else
            # Stable releases are immutable: fail if the release already exists.
            if gh release view "${tag}" >/dev/null 2>&1; then
              echo "Release ${tag} already exists. Stable releases are immutable; refusing to modify it."
              exit 1
            fi
            gh release create "${tag}" \
              "${jar}" \
              "${sources_jar}" \
              --title "cbbg ${tag}" \
              --notes-file release_notes.md
          fi


